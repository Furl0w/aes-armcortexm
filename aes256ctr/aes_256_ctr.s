.syntax unified

.align 2
.type AES_Te0,%object
AES_Te0:
.word 0xa56363c6, 0x847c7cf8, 0x997777ee, 0x8d7b7bf6
.word 0x0df2f2ff, 0xbd6b6bd6, 0xb16f6fde, 0x54c5c591
.word 0x50303060, 0x03010102, 0xa96767ce, 0x7d2b2b56
.word 0x19fefee7, 0x62d7d7b5, 0xe6abab4d, 0x9a7676ec
.word 0x45caca8f, 0x9d82821f, 0x40c9c989, 0x877d7dfa
.word 0x15fafaef, 0xeb5959b2, 0xc947478e, 0x0bf0f0fb
.word 0xecadad41, 0x67d4d4b3, 0xfda2a25f, 0xeaafaf45
.word 0xbf9c9c23, 0xf7a4a453, 0x967272e4, 0x5bc0c09b
.word 0xc2b7b775, 0x1cfdfde1, 0xae93933d, 0x6a26264c
.word 0x5a36366c, 0x413f3f7e, 0x02f7f7f5, 0x4fcccc83
.word 0x5c343468, 0xf4a5a551, 0x34e5e5d1, 0x08f1f1f9
.word 0x937171e2, 0x73d8d8ab, 0x53313162, 0x3f15152a
.word 0x0c040408, 0x52c7c795, 0x65232346, 0x5ec3c39d
.word 0x28181830, 0xa1969637, 0x0f05050a, 0xb59a9a2f
.word 0x0907070e, 0x36121224, 0x9b80801b, 0x3de2e2df
.word 0x26ebebcd, 0x6927274e, 0xcdb2b27f, 0x9f7575ea
.word 0x1b090912, 0x9e83831d, 0x742c2c58, 0x2e1a1a34
.word 0x2d1b1b36, 0xb26e6edc, 0xee5a5ab4, 0xfba0a05b
.word 0xf65252a4, 0x4d3b3b76, 0x61d6d6b7, 0xceb3b37d
.word 0x7b292952, 0x3ee3e3dd, 0x712f2f5e, 0x97848413
.word 0xf55353a6, 0x68d1d1b9, 0x00000000, 0x2cededc1
.word 0x60202040, 0x1ffcfce3, 0xc8b1b179, 0xed5b5bb6
.word 0xbe6a6ad4, 0x46cbcb8d, 0xd9bebe67, 0x4b393972
.word 0xde4a4a94, 0xd44c4c98, 0xe85858b0, 0x4acfcf85
.word 0x6bd0d0bb, 0x2aefefc5, 0xe5aaaa4f, 0x16fbfbed
.word 0xc5434386, 0xd74d4d9a, 0x55333366, 0x94858511
.word 0xcf45458a, 0x10f9f9e9, 0x06020204, 0x817f7ffe
.word 0xf05050a0, 0x443c3c78, 0xba9f9f25, 0xe3a8a84b
.word 0xf35151a2, 0xfea3a35d, 0xc0404080, 0x8a8f8f05
.word 0xad92923f, 0xbc9d9d21, 0x48383870, 0x04f5f5f1
.word 0xdfbcbc63, 0xc1b6b677, 0x75dadaaf, 0x63212142
.word 0x30101020, 0x1affffe5, 0x0ef3f3fd, 0x6dd2d2bf
.word 0x4ccdcd81, 0x140c0c18, 0x35131326, 0x2fececc3
.word 0xe15f5fbe, 0xa2979735, 0xcc444488, 0x3917172e
.word 0x57c4c493, 0xf2a7a755, 0x827e7efc, 0x473d3d7a
.word 0xac6464c8, 0xe75d5dba, 0x2b191932, 0x957373e6
.word 0xa06060c0, 0x98818119, 0xd14f4f9e, 0x7fdcdca3
.word 0x66222244, 0x7e2a2a54, 0xab90903b, 0x8388880b
.word 0xca46468c, 0x29eeeec7, 0xd3b8b86b, 0x3c141428
.word 0x79dedea7, 0xe25e5ebc, 0x1d0b0b16, 0x76dbdbad
.word 0x3be0e0db, 0x56323264, 0x4e3a3a74, 0x1e0a0a14
.word 0xdb494992, 0x0a06060c, 0x6c242448, 0xe45c5cb8
.word 0x5dc2c29f, 0x6ed3d3bd, 0xefacac43, 0xa66262c4
.word 0xa8919139, 0xa4959531, 0x37e4e4d3, 0x8b7979f2
.word 0x32e7e7d5, 0x43c8c88b, 0x5937376e, 0xb76d6dda
.word 0x8c8d8d01, 0x64d5d5b1, 0xd24e4e9c, 0xe0a9a949
.word 0xb46c6cd8, 0xfa5656ac, 0x07f4f4f3, 0x25eaeacf
.word 0xaf6565ca, 0x8e7a7af4, 0xe9aeae47, 0x18080810
.word 0xd5baba6f, 0x887878f0, 0x6f25254a, 0x722e2e5c
.word 0x241c1c38, 0xf1a6a657, 0xc7b4b473, 0x51c6c697
.word 0x23e8e8cb, 0x7cdddda1, 0x9c7474e8, 0x211f1f3e
.word 0xdd4b4b96, 0xdcbdbd61, 0x868b8b0d, 0x858a8a0f
.word 0x907070e0, 0x423e3e7c, 0xc4b5b571, 0xaa6666cc
.word 0xd8484890, 0x05030306, 0x01f6f6f7, 0x120e0e1c
.word 0xa36161c2, 0x5f35356a, 0xf95757ae, 0xd0b9b969
.word 0x91868617, 0x58c1c199, 0x271d1d3a, 0xb99e9e27
.word 0x38e1e1d9, 0x13f8f8eb, 0xb398982b, 0x33111122
.word 0xbb6969d2, 0x70d9d9a9, 0x898e8e07, 0xa7949433
.word 0xb69b9b2d, 0x221e1e3c, 0x92878715, 0x20e9e9c9
.word 0x49cece87, 0xff5555aa, 0x78282850, 0x7adfdfa5
.word 0x8f8c8c03, 0xf8a1a159, 0x80898909, 0x170d0d1a
.word 0xdabfbf65, 0x31e6e6d7, 0xc6424284, 0xb86868d0
.word 0xc3414182, 0xb0999929, 0x772d2d5a, 0x110f0f1e
.word 0xcbb0b07b, 0xfc5454a8, 0xd6bbbb6d, 0x3a16162c

@ unsigned int AES_256_keyschedule(const uint8_t *key,
@       uint8_t *rk) {
.global AES_256_keyschedule
.thumb
AES_256_keyschedule:

    //function prologue, preserve registers
    push {r4-r12,r14}

    //load key
    ldm r0, {r2-r9}

    //load table address once
    adr r0, AES_Te0

    //round 1
    uxtb r10, r9, ror #8
    uxtb r11, r9, ror #16
    uxtb r12, r9, ror #24
    uxtb r14, r9

    ldr r10, [r0, r10, lsl #2]
    ldr r11, [r0, r11, lsl #2]
    ldr r12, [r0, r12, lsl #2]
    ldr r14, [r0, r14, lsl #2]

    and r10, #0x00ff0000
    and r11, #0x00ff0000
    and r12, #0x00ff0000
    and r14, #0x00ff0000

    eor r2, #0x00000001 //rcon
    eor r2, r2, r10, lsr #16
    eor r2, r2, r11, lsr #8
    eor r2, r12
    eor r2, r2, r14, lsl #8 //rk[8]
    eor r3, r2 //rk[9]
    eor r4, r3 //rk[10]
    eor r5, r4 //rk[11]

    uxtb r10, r5, ror #16
    uxtb r11, r5, ror #8
    uxtb r12, r5
    uxtb r14, r5, ror #24

    ldr r10, [r0, r10, lsl #2]
    ldr r11, [r0, r11, lsl #2]
    ldr r12, [r0, r12, lsl #2]
    ldr r14, [r0, r14, lsl #2]

    and r10, #0x00ff0000
    and r11, #0x00ff0000
    and r12, #0x00ff0000
    and r14, #0x00ff0000

    eor r6, r10
    eor r6, r6, r11, lsr #8
    eor r6, r6, r12, lsr #16
    eor r6, r6, r14, lsl #8 //rk[12]
    eor r7, r6 //rk[13]
    eor r8, r7 //rk[14]
    eor r9, r8 //rk[15]

    //write to memory
    //stmia.w r1!, {r2-r9} is slower if we can use encoding T1!
    str r2, [r1, #0]
    str r3, [r1, #4]
    str r4, [r1, #8]
    str r5, [r1, #12]
    str r6, [r1, #16]
    str r7, [r1, #20]
    str r8, [r1, #24]
    str r9, [r1, #28]

    //round 2
    uxtb r10, r9, ror #8
    uxtb r11, r9, ror #16
    uxtb r12, r9, ror #24
    uxtb r14, r9

    ldr r10, [r0, r10, lsl #2]
    ldr r11, [r0, r11, lsl #2]
    ldr r12, [r0, r12, lsl #2]
    ldr r14, [r0, r14, lsl #2]

    and r10, #0x00ff0000
    and r11, #0x00ff0000
    and r12, #0x00ff0000
    and r14, #0x00ff0000

    eor r2, #0x00000002 //rcon
    eor r2, r2, r10, lsr #16
    eor r2, r2, r11, lsr #8
    eor r2, r12
    eor r2, r2, r14, lsl #8 //rk[16]
    eor r3, r2 //rk[17]
    eor r4, r3 //rk[18]
    eor r5, r4 //rk[19]

    uxtb r10, r5, ror #16
    uxtb r11, r5, ror #8
    uxtb r12, r5
    uxtb r14, r5, ror #24

    ldr r10, [r0, r10, lsl #2]
    ldr r11, [r0, r11, lsl #2]
    ldr r12, [r0, r12, lsl #2]
    ldr r14, [r0, r14, lsl #2]

    and r10, #0x00ff0000
    and r11, #0x00ff0000
    and r12, #0x00ff0000
    and r14, #0x00ff0000

    eor r6, r10
    eor r6, r6, r11, lsr #8
    eor r6, r6, r12, lsr #16
    eor r6, r6, r14, lsl #8 //rk[20]
    eor r7, r6 //rk[21]
    eor r8, r7 //rk[22]
    eor r9, r8 //rk[23]

    //write to memory
    //stmia.w r1!, {r2-r9} is slower if we can use encoding T1!
    str r2, [r1, #32]
    str r3, [r1, #36]
    str r4, [r1, #40]
    str r5, [r1, #44]
    str r6, [r1, #48]
    str r7, [r1, #52]
    str r8, [r1, #56]
    str r9, [r1, #60]

    //round 3
    uxtb r10, r9, ror #8
    uxtb r11, r9, ror #16
    uxtb r12, r9, ror #24
    uxtb r14, r9

    ldr r10, [r0, r10, lsl #2]
    ldr r11, [r0, r11, lsl #2]
    ldr r12, [r0, r12, lsl #2]
    ldr r14, [r0, r14, lsl #2]

    and r10, #0x00ff0000
    and r11, #0x00ff0000
    and r12, #0x00ff0000
    and r14, #0x00ff0000

    eor r2, #0x00000004 //rcon
    eor r2, r2, r10, lsr #16
    eor r2, r2, r11, lsr #8
    eor r2, r12
    eor r2, r2, r14, lsl #8 //rk[24]
    eor r3, r2 //rk[25]
    eor r4, r3 //rk[26]
    eor r5, r4 //rk[27]

    uxtb r10, r5, ror #16
    uxtb r11, r5, ror #8
    uxtb r12, r5
    uxtb r14, r5, ror #24

    ldr r10, [r0, r10, lsl #2]
    ldr r11, [r0, r11, lsl #2]
    ldr r12, [r0, r12, lsl #2]
    ldr r14, [r0, r14, lsl #2]

    and r10, #0x00ff0000
    and r11, #0x00ff0000
    and r12, #0x00ff0000
    and r14, #0x00ff0000

    eor r6, r10
    eor r6, r6, r11, lsr #8
    eor r6, r6, r12, lsr #16
    eor r6, r6, r14, lsl #8 //rk[28]
    eor r7, r6 //rk[29]
    eor r8, r7 //rk[30]
    eor r9, r8 //rk[31]

    //write to memory
    //stmia.w r1!, {r2-r9} is slower if we can use encoding T1!
    str r2, [r1, #64]
    str r3, [r1, #68]
    str r4, [r1, #72]
    str r5, [r1, #76]
    str r6, [r1, #80]
    str r7, [r1, #84]
    str r8, [r1, #88]
    str r9, [r1, #92]

    //round 4
    uxtb r10, r9, ror #8
    uxtb r11, r9, ror #16
    uxtb r12, r9, ror #24
    uxtb r14, r9

    ldr r10, [r0, r10, lsl #2]
    ldr r11, [r0, r11, lsl #2]
    ldr r12, [r0, r12, lsl #2]
    ldr r14, [r0, r14, lsl #2]

    and r10, #0x00ff0000
    and r11, #0x00ff0000
    and r12, #0x00ff0000
    and r14, #0x00ff0000

    eor r2, #0x00000008 //rcon
    eor r2, r2, r10, lsr #16
    eor r2, r2, r11, lsr #8
    eor r2, r12
    eor r2, r2, r14, lsl #8 //rk[32]
    eor r3, r2 //rk[33]
    eor r4, r3 //rk[34]
    eor r5, r4 //rk[35]

    uxtb r10, r5, ror #16
    uxtb r11, r5, ror #8
    uxtb r12, r5
    uxtb r14, r5, ror #24

    ldr r10, [r0, r10, lsl #2]
    ldr r11, [r0, r11, lsl #2]
    ldr r12, [r0, r12, lsl #2]
    ldr r14, [r0, r14, lsl #2]

    and r10, #0x00ff0000
    and r11, #0x00ff0000
    and r12, #0x00ff0000
    and r14, #0x00ff0000

    eor r6, r10
    eor r6, r6, r11, lsr #8
    eor r6, r6, r12, lsr #16
    eor r6, r6, r14, lsl #8 //rk[36]
    eor r7, r6 //rk[37]
    eor r8, r7 //rk[38]
    eor r9, r8 //rk[39]

    //write to memory
    //stmia.w r1!, {r2-r9} is slower if we can use encoding T1!
    str r2, [r1, #96]
    str r3, [r1, #100]
    str r4, [r1, #104]
    str r5, [r1, #108]
    str r6, [r1, #112]
    str r7, [r1, #116]
    str r8, [r1, #120]
    str r9, [r1, #124]

    add r1, #128

    //round 5
    uxtb r10, r9, ror #8
    uxtb r11, r9, ror #16
    uxtb r12, r9, ror #24
    uxtb r14, r9

    ldr r10, [r0, r10, lsl #2]
    ldr r11, [r0, r11, lsl #2]
    ldr r12, [r0, r12, lsl #2]
    ldr r14, [r0, r14, lsl #2]

    and r10, #0x00ff0000
    and r11, #0x00ff0000
    and r12, #0x00ff0000
    and r14, #0x00ff0000

    eor r2, #0x00000010 //rcon
    eor r2, r2, r10, lsr #16
    eor r2, r2, r11, lsr #8
    eor r2, r12
    eor r2, r2, r14, lsl #8 //rk[40]
    eor r3, r2 //rk[41]
    eor r4, r3 //rk[42]
    eor r5, r4 //rk[43]

    uxtb r10, r5, ror #16
    uxtb r11, r5, ror #8
    uxtb r12, r5
    uxtb r14, r5, ror #24

    ldr r10, [r0, r10, lsl #2]
    ldr r11, [r0, r11, lsl #2]
    ldr r12, [r0, r12, lsl #2]
    ldr r14, [r0, r14, lsl #2]

    and r10, #0x00ff0000
    and r11, #0x00ff0000
    and r12, #0x00ff0000
    and r14, #0x00ff0000

    eor r6, r10
    eor r6, r6, r11, lsr #8
    eor r6, r6, r12, lsr #16
    eor r6, r6, r14, lsl #8 //rk[44]
    eor r7, r6 //rk[45]
    eor r8, r7 //rk[46]
    eor r9, r8 //rk[47]

    //write to memory
    //stmia.w r1!, {r2-r9} is slower if we can use encoding T1!
    str r2, [r1, #0]
    str r3, [r1, #4]
    str r4, [r1, #8]
    str r5, [r1, #12]
    str r6, [r1, #16]
    str r7, [r1, #20]
    str r8, [r1, #24]
    str r9, [r1, #28]

    //round 6
    uxtb r10, r9, ror #8
    uxtb r11, r9, ror #16
    uxtb r12, r9, ror #24
    uxtb r14, r9

    ldr r10, [r0, r10, lsl #2]
    ldr r11, [r0, r11, lsl #2]
    ldr r12, [r0, r12, lsl #2]
    ldr r14, [r0, r14, lsl #2]

    and r10, #0x00ff0000
    and r11, #0x00ff0000
    and r12, #0x00ff0000
    and r14, #0x00ff0000

    eor r2, #0x00000020 //rcon
    eor r2, r2, r10, lsr #16
    eor r2, r2, r11, lsr #8
    eor r2, r12
    eor r2, r2, r14, lsl #8 //rk[48]
    eor r3, r2 //rk[49]
    eor r4, r3 //rk[50]
    eor r5, r4 //rk[51]

    uxtb r10, r5, ror #16
    uxtb r11, r5, ror #8
    uxtb r12, r5
    uxtb r14, r5, ror #24

    ldr r10, [r0, r10, lsl #2]
    ldr r11, [r0, r11, lsl #2]
    ldr r12, [r0, r12, lsl #2]
    ldr r14, [r0, r14, lsl #2]

    and r10, #0x00ff0000
    and r11, #0x00ff0000
    and r12, #0x00ff0000
    and r14, #0x00ff0000

    eor r6, r10
    eor r6, r6, r11, lsr #8
    eor r6, r6, r12, lsr #16
    eor r6, r6, r14, lsl #8 //rk[52]
    eor r7, r6 //rk[53]
    eor r8, r7 //rk[54]
    eor r9, r8 //rk[55]

    //write to memory
    //stmia.w r1!, {r2-r9} is slower if we can use encoding T1!
    str r2, [r1, #32]
    str r3, [r1, #36]
    str r4, [r1, #40]
    str r5, [r1, #44]
    str r6, [r1, #48]
    str r7, [r1, #52]
    str r8, [r1, #56]
    str r9, [r1, #60]

    //round 7
    uxtb r10, r9, ror #8
    uxtb r11, r9, ror #16
    uxtb r12, r9, ror #24
    uxtb r14, r9

    ldr r10, [r0, r10, lsl #2]
    ldr r11, [r0, r11, lsl #2]
    ldr r12, [r0, r12, lsl #2]
    ldr r14, [r0, r14, lsl #2]

    and r10, #0x00ff0000
    and r11, #0x00ff0000
    and r12, #0x00ff0000
    and r14, #0x00ff0000

    eor r2, #0x00000040 //rcon
    eor r2, r2, r10, lsr #16
    eor r2, r2, r11, lsr #8
    eor r2, r12
    eor r2, r2, r14, lsl #8 //rk[56]
    eor r3, r2 //rk[57]
    eor r4, r3 //rk[58]
    eor r5, r4 //rk[59]

    //write to memory
    //stmia.w r1!, {r2-r5} is slower if we can use encoding T1!
    str r2, [r1, #64]
    str r3, [r1, #68]
    str r4, [r1, #72]
    str r5, [r1, #76]

    //function epilogue, restore state
    pop {r4-r12,r14}
    bx lr


.align 2
@ unsigned int AES_256_encrypt_ctr(param const *p,
@       const uint8_t *in, uint8_t *out,
@       uint32_t len) {
.global AES_256_encrypt_ctr
.thumb
.type   AES_256_encrypt_ctr,%function
AES_256_encrypt_ctr:

    //function prologue, preserve registers
    push {r1-r12,r14}

    mov.w r14, r0

    //load table address once
    adr r12, AES_Te0

    //do counter-mode caching precomputation
.align 2
partial_precompute: //expect p in r14

    //load from p ctrnonce in r4-r7, key in r8-r11
    ldmia r14!, {r4-r11}

    //initial addroundkey
    eor r4, r8
    eor r5, r9
    eor r6, r10
    eor r7, r11
    and r4, r4, #0xffffff00

    //round 1

    ldmia r14!, {r8-r11} //rk[4]-rk[7]
    uxtb r0, r4
    uxtb r1, r5
    uxtb r2, r6
    uxtb r3, r7
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r0
    eor r9, r1
    eor r10, r2
    eor r11, r3

    uxtb r0, r5, ror #8
    uxtb r1, r6, ror #8
    uxtb r2, r7, ror #8
    uxtb r3, r4, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #24
    eor r9, r9, r1, ror #24
    eor r10, r10, r2, ror #24
    eor r11, r11, r3, ror #24

    uxtb r0, r6, ror #16
    uxtb r1, r7, ror #16
    uxtb r2, r4, ror #16
    uxtb r3, r5, ror #16
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #16
    eor r9, r9, r1, ror #16
    eor r10, r10, r2, ror #16
    eor r11, r11, r3, ror #16

    uxtb r0, r7, ror #24
    uxtb r1, r4, ror #24
    uxtb r2, r5, ror #24
    uxtb r4, r6, ror #24
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r4, [r12, r4, lsl #2]
    ldr r3, [r12, #0] //keep this value here throughout round 2 to save loads
    eor r8, r8, r0, ror #8
    eor r9, r9, r1, ror #8
    eor r10, r10, r2, ror #8
    eor r11, r11, r4, ror #8
    eor r1, r3, r8
    push.w {r1}

    //round 2

    ldmia.w r14!, {r4-r7} //rk[8]-rk[11]

    uxtb r0, r9
    uxtb r1, r10
    uxtb r2, r11
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    eor r4, r3
    eor r5, r0
    eor r6, r1
    eor r7, r2

    uxtb r0, r9, ror #8
    uxtb r1, r10, ror #8
    uxtb r2, r11, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    eor r4, r4, r0, ror #24
    eor r5, r5, r1, ror #24
    eor r6, r6, r2, ror #24
    eor r7, r7, r3, ror #24

    uxtb r0, r10, ror #16
    uxtb r1, r11, ror #16
    uxtb r2, r9, ror #16
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    eor r4, r4, r0, ror #16
    eor r5, r5, r1, ror #16
    eor r6, r6, r3, ror #16
    eor r7, r7, r2, ror #16

    uxtb r0, r11, ror #24
    uxtb r1, r9, ror #24
    uxtb r2, r10, ror #24
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    eor r4, r4, r0, ror #8
    eor r5, r5, r3, ror #8
    eor r6, r6, r1, ror #8
    eor r7, r7, r2, ror #8

    eor r4, r3
    eor r5, r5, r3, ror #8
    eor r6, r6, r3, ror #16
    eor r7, r7, r3, ror #24
    push.w {r4-r7}
    //load precomputed_x0
    ldr r10, [sp, #16]
    //the first time, we can skip some loads
    b.w encrypt_first

    //do full AES on one block using precomputated values
.align 2
encrypt_block: //expect {precomputed_x0, precomputed_y0..y3} on top of stack, p+4*4*4 in r14

    //load precomputed
    ldm sp, {r4-r7,r10}
encrypt_first:
    //load ctr
    ldr r8, [r14, #-64]
    //load key[0]
    ldr r9, [r14, #-48]

    //round 1
    eor r8, r9
    and r8, #0xff
    ldr r8, [r12, r8, lsl #2]
    eor r10, r8

    //round 2
    uxtb r0, r10
    uxtb r1, r10, ror #24
    uxtb r2, r10, ror #16
    uxtb r3, r10, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0
    eor r5, r5, r1, ror #8
    eor r6, r6, r2, ror #16
    eor r7, r7, r3, ror #24

    //round 3

    ldmia r14!, {r8-r11} //rk[64]-rk[12]

    uxtb r0, r4
    uxtb r1, r5
    uxtb r2, r6
    uxtb r3, r7
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r0
    eor r9, r1
    eor r10, r2
    eor r11, r3

    uxtb r0, r5, ror #8
    uxtb r1, r6, ror #8
    uxtb r2, r7, ror #8
    uxtb r3, r4, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #24
    eor r9, r9, r1, ror #24
    eor r10, r10, r2, ror #24
    eor r11, r11, r3, ror #24

    uxtb r0, r6, ror #16
    uxtb r1, r7, ror #16
    uxtb r2, r4, ror #16
    uxtb r3, r5, ror #16
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #16
    eor r9, r9, r1, ror #16
    eor r10, r10, r2, ror #16
    eor r11, r11, r3, ror #16

    uxtb r0, r7, ror #24
    uxtb r1, r4, ror #24
    uxtb r2, r5, ror #24
    uxtb r3, r6, ror #24
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #8
    eor r9, r9, r1, ror #8
    eor r10, r10, r2, ror #8
    eor r11, r11, r3, ror #8

    //round 4

    ldmia r14!, {r4-r7} //rk[80]-rk[16]

    uxtb r0, r8
    uxtb r1, r9
    uxtb r2, r10
    uxtb r3, r11
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r0
    eor r5, r1
    eor r6, r2
    eor r7, r3

    uxtb r0, r9, ror #8
    uxtb r1, r10, ror #8
    uxtb r2, r11, ror #8
    uxtb r3, r8, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #24
    eor r5, r5, r1, ror #24
    eor r6, r6, r2, ror #24
    eor r7, r7, r3, ror #24

    uxtb r0, r10, ror #16
    uxtb r1, r11, ror #16
    uxtb r2, r8, ror #16
    uxtb r3, r9, ror #16
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #16
    eor r5, r5, r1, ror #16
    eor r6, r6, r2, ror #16
    eor r7, r7, r3, ror #16

    uxtb r0, r11, ror #24
    uxtb r1, r8, ror #24
    uxtb r2, r9, ror #24
    uxtb r3, r10, ror #24
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #8
    eor r5, r5, r1, ror #8
    eor r6, r6, r2, ror #8
    eor r7, r7, r3, ror #8

    //round 5

    ldmia r14!, {r8-r11} //rk[96]-rk[20]

    uxtb r0, r4
    uxtb r1, r5
    uxtb r2, r6
    uxtb r3, r7
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r0
    eor r9, r1
    eor r10, r2
    eor r11, r3

    uxtb r0, r5, ror #8
    uxtb r1, r6, ror #8
    uxtb r2, r7, ror #8
    uxtb r3, r4, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #24
    eor r9, r9, r1, ror #24
    eor r10, r10, r2, ror #24
    eor r11, r11, r3, ror #24

    uxtb r0, r6, ror #16
    uxtb r1, r7, ror #16
    uxtb r2, r4, ror #16
    uxtb r3, r5, ror #16
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #16
    eor r9, r9, r1, ror #16
    eor r10, r10, r2, ror #16
    eor r11, r11, r3, ror #16

    uxtb r0, r7, ror #24
    uxtb r1, r4, ror #24
    uxtb r2, r5, ror #24
    uxtb r3, r6, ror #24
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #8
    eor r9, r9, r1, ror #8
    eor r10, r10, r2, ror #8
    eor r11, r11, r3, ror #8

    //round 6

    ldmia r14!, {r4-r7} //rk[112]-rk[24]

    uxtb r0, r8
    uxtb r1, r9
    uxtb r2, r10
    uxtb r3, r11
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r0
    eor r5, r1
    eor r6, r2
    eor r7, r3

    uxtb r0, r9, ror #8
    uxtb r1, r10, ror #8
    uxtb r2, r11, ror #8
    uxtb r3, r8, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #24
    eor r5, r5, r1, ror #24
    eor r6, r6, r2, ror #24
    eor r7, r7, r3, ror #24

    uxtb r0, r10, ror #16
    uxtb r1, r11, ror #16
    uxtb r2, r8, ror #16
    uxtb r3, r9, ror #16
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #16
    eor r5, r5, r1, ror #16
    eor r6, r6, r2, ror #16
    eor r7, r7, r3, ror #16

    uxtb r0, r11, ror #24
    uxtb r1, r8, ror #24
    uxtb r2, r9, ror #24
    uxtb r3, r10, ror #24
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #8
    eor r5, r5, r1, ror #8
    eor r6, r6, r2, ror #8
    eor r7, r7, r3, ror #8

    //round 7

    ldmia r14!, {r8-r11} //rk[128]-rk[28]

    uxtb r0, r4
    uxtb r1, r5
    uxtb r2, r6
    uxtb r3, r7
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r0
    eor r9, r1
    eor r10, r2
    eor r11, r3

    uxtb r0, r5, ror #8
    uxtb r1, r6, ror #8
    uxtb r2, r7, ror #8
    uxtb r3, r4, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #24
    eor r9, r9, r1, ror #24
    eor r10, r10, r2, ror #24
    eor r11, r11, r3, ror #24

    uxtb r0, r6, ror #16
    uxtb r1, r7, ror #16
    uxtb r2, r4, ror #16
    uxtb r3, r5, ror #16
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #16
    eor r9, r9, r1, ror #16
    eor r10, r10, r2, ror #16
    eor r11, r11, r3, ror #16

    uxtb r0, r7, ror #24
    uxtb r1, r4, ror #24
    uxtb r2, r5, ror #24
    uxtb r3, r6, ror #24
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #8
    eor r9, r9, r1, ror #8
    eor r10, r10, r2, ror #8
    eor r11, r11, r3, ror #8

    //round 8

    ldmia r14!, {r4-r7} //rk[144]-rk[32]

    uxtb r0, r8
    uxtb r1, r9
    uxtb r2, r10
    uxtb r3, r11
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r0
    eor r5, r1
    eor r6, r2
    eor r7, r3

    uxtb r0, r9, ror #8
    uxtb r1, r10, ror #8
    uxtb r2, r11, ror #8
    uxtb r3, r8, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #24
    eor r5, r5, r1, ror #24
    eor r6, r6, r2, ror #24
    eor r7, r7, r3, ror #24

    uxtb r0, r10, ror #16
    uxtb r1, r11, ror #16
    uxtb r2, r8, ror #16
    uxtb r3, r9, ror #16
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #16
    eor r5, r5, r1, ror #16
    eor r6, r6, r2, ror #16
    eor r7, r7, r3, ror #16

    uxtb r0, r11, ror #24
    uxtb r1, r8, ror #24
    uxtb r2, r9, ror #24
    uxtb r3, r10, ror #24
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #8
    eor r5, r5, r1, ror #8
    eor r6, r6, r2, ror #8
    eor r7, r7, r3, ror #8

    //round 9

    ldmia r14!, {r8-r11} //rk[160]-rk[36]

    uxtb r0, r4
    uxtb r1, r5
    uxtb r2, r6
    uxtb r3, r7
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r0
    eor r9, r1
    eor r10, r2
    eor r11, r3

    uxtb r0, r5, ror #8
    uxtb r1, r6, ror #8
    uxtb r2, r7, ror #8
    uxtb r3, r4, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #24
    eor r9, r9, r1, ror #24
    eor r10, r10, r2, ror #24
    eor r11, r11, r3, ror #24

    uxtb r0, r6, ror #16
    uxtb r1, r7, ror #16
    uxtb r2, r4, ror #16
    uxtb r3, r5, ror #16
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #16
    eor r9, r9, r1, ror #16
    eor r10, r10, r2, ror #16
    eor r11, r11, r3, ror #16

    uxtb r0, r7, ror #24
    uxtb r1, r4, ror #24
    uxtb r2, r5, ror #24
    uxtb r3, r6, ror #24
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #8
    eor r9, r9, r1, ror #8
    eor r10, r10, r2, ror #8
    eor r11, r11, r3, ror #8

    //round 10

    ldmia r14!, {r4-r7} //rk[176]-rk[40]

    uxtb r0, r8
    uxtb r1, r9
    uxtb r2, r10
    uxtb r3, r11
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r0
    eor r5, r1
    eor r6, r2
    eor r7, r3

    uxtb r0, r9, ror #8
    uxtb r1, r10, ror #8
    uxtb r2, r11, ror #8
    uxtb r3, r8, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #24
    eor r5, r5, r1, ror #24
    eor r6, r6, r2, ror #24
    eor r7, r7, r3, ror #24

    uxtb r0, r10, ror #16
    uxtb r1, r11, ror #16
    uxtb r2, r8, ror #16
    uxtb r3, r9, ror #16
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #16
    eor r5, r5, r1, ror #16
    eor r6, r6, r2, ror #16
    eor r7, r7, r3, ror #16

    uxtb r0, r11, ror #24
    uxtb r1, r8, ror #24
    uxtb r2, r9, ror #24
    uxtb r3, r10, ror #24
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #8
    eor r5, r5, r1, ror #8
    eor r6, r6, r2, ror #8
    eor r7, r7, r3, ror #8

    //round 11

    ldmia r14!, {r8-r11} //rk[192]-rk[44]

    uxtb r0, r4
    uxtb r1, r5
    uxtb r2, r6
    uxtb r3, r7
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r0
    eor r9, r1
    eor r10, r2
    eor r11, r3

    uxtb r0, r5, ror #8
    uxtb r1, r6, ror #8
    uxtb r2, r7, ror #8
    uxtb r3, r4, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #24
    eor r9, r9, r1, ror #24
    eor r10, r10, r2, ror #24
    eor r11, r11, r3, ror #24

    uxtb r0, r6, ror #16
    uxtb r1, r7, ror #16
    uxtb r2, r4, ror #16
    uxtb r3, r5, ror #16
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #16
    eor r9, r9, r1, ror #16
    eor r10, r10, r2, ror #16
    eor r11, r11, r3, ror #16

    uxtb r0, r7, ror #24
    uxtb r1, r4, ror #24
    uxtb r2, r5, ror #24
    uxtb r3, r6, ror #24
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #8
    eor r9, r9, r1, ror #8
    eor r10, r10, r2, ror #8
    eor r11, r11, r3, ror #8

    //round 12

    ldmia r14!, {r4-r7} //rk[208]-rk[48]

    uxtb r0, r8
    uxtb r1, r9
    uxtb r2, r10
    uxtb r3, r11
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r0
    eor r5, r1
    eor r6, r2
    eor r7, r3

    uxtb r0, r9, ror #8
    uxtb r1, r10, ror #8
    uxtb r2, r11, ror #8
    uxtb r3, r8, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #24
    eor r5, r5, r1, ror #24
    eor r6, r6, r2, ror #24
    eor r7, r7, r3, ror #24

    uxtb r0, r10, ror #16
    uxtb r1, r11, ror #16
    uxtb r2, r8, ror #16
    uxtb r3, r9, ror #16
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #16
    eor r5, r5, r1, ror #16
    eor r6, r6, r2, ror #16
    eor r7, r7, r3, ror #16

    uxtb r0, r11, ror #24
    uxtb r1, r8, ror #24
    uxtb r2, r9, ror #24
    uxtb r3, r10, ror #24
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r4, r4, r0, ror #8
    eor r5, r5, r1, ror #8
    eor r6, r6, r2, ror #8
    eor r7, r7, r3, ror #8

    //round 13

    ldmia r14!, {r8-r11} //rk[224]-rk[52]

    uxtb r0, r4
    uxtb r1, r5
    uxtb r2, r6
    uxtb r3, r7
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r0
    eor r9, r1
    eor r10, r2
    eor r11, r3

    uxtb r0, r5, ror #8
    uxtb r1, r6, ror #8
    uxtb r2, r7, ror #8
    uxtb r3, r4, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #24
    eor r9, r9, r1, ror #24
    eor r10, r10, r2, ror #24
    eor r11, r11, r3, ror #24

    uxtb r0, r6, ror #16
    uxtb r1, r7, ror #16
    uxtb r2, r4, ror #16
    uxtb r3, r5, ror #16
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #16
    eor r9, r9, r1, ror #16
    eor r10, r10, r2, ror #16
    eor r11, r11, r3, ror #16

    uxtb r0, r7, ror #24
    uxtb r1, r4, ror #24
    uxtb r2, r5, ror #24
    uxtb r3, r6, ror #24
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    eor r8, r8, r0, ror #8
    eor r9, r9, r1, ror #8
    eor r10, r10, r2, ror #8
    eor r11, r11, r3, ror #8

    //round 14

    ldmia r14!, {r4-r7} //rk[56]-rk[59]

    uxtb r0, r10, ror #16
    uxtb r1, r11, ror #16
    uxtb r2, r8, ror #16
    uxtb r3, r9, ror #16
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    and r0, #0x00ff0000
    and r1, #0x00ff0000
    and r2, #0x00ff0000
    and r3, #0x00ff0000
    eor r4, r0
    eor r5, r1
    eor r6, r2
    eor r7, r3

    uxtb r0, r11, ror #24
    uxtb r1, r8, ror #24
    uxtb r2, r9, ror #24
    uxtb r3, r10, ror #24
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    and r0, #0x00ff0000
    and r1, #0x00ff0000
    and r2, #0x00ff0000
    and r3, #0x00ff0000
    eor r4, r4, r0, lsl #8
    eor r5, r5, r1, lsl #8
    eor r6, r6, r2, lsl #8
    eor r7, r7, r3, lsl #8

    uxtb r0, r8
    uxtb r1, r9
    uxtb r2, r10
    uxtb r3, r11
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    and r0, #0x00ff0000
    and r1, #0x00ff0000
    and r2, #0x00ff0000
    and r3, #0x00ff0000
    eor r4, r4, r0, lsr #16
    eor r5, r5, r1, lsr #16
    eor r6, r6, r2, lsr #16
    eor r7, r7, r3, lsr #16

    uxtb r0, r9, ror #8
    uxtb r1, r10, ror #8
    uxtb r2, r11, ror #8
    uxtb r3, r8, ror #8
    ldr r0, [r12, r0, lsl #2]
    ldr r1, [r12, r1, lsl #2]
    ldr r2, [r12, r2, lsl #2]
    ldr r3, [r12, r3, lsl #2]
    and r0, #0x00ff0000
    and r1, #0x00ff0000
    and r2, #0x00ff0000
    and r3, #0x00ff0000
    eor r4, r4, r0, lsr #8
    eor r5, r5, r1, lsr #8
    eor r6, r6, r2, lsr #8
    eor r7, r7, r3, lsr #8

    //load in, out, len counter
    add r8, sp, #20 //step over precomputed_*
    ldmia r8, {r1-r3}

    //load input, xor keystream and write to output
    ldmia r1!, {r8-r11}
    str.w r1, [sp, #20]
    eor r4, r8
    eor r5, r9
    eor r6, r10
    eor r7, r11
    stmia r2!, {r4-r7}
    str r2, [sp, #24]

    //dec and store len counter
    subs r3, #16
    ble exit //if len<=0: exit
    str.w r3, [sp, #28]

    //load, inc, store ctrnonce
    sub r14, #192 //reset to p+4*4*4, as required by encrypt_block
    ldr r4, [r14, #-64]
    add r4, #1
    str r4, [r14, #-64]

    //if ctrnonce%256==0: partial_precompute
    ands r4, r4, #0xff
    bne encrypt_block
    add.w sp, #20 //remove precomputed_*
    sub r14, #64 //reset to p, as required by partial_precompute
    b partial_precompute

.align 2
exit:
    //function epilogue, restore state
    add sp, #32
    pop {r4-r12,r14}
    bx lr

